<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Write-ups â€” Solasaki Comics</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="fade">

<header>
  <div class="logoarea">
    <img src="assets/uploads/IMG_0079.jpeg" style="width:48px;height:48px;border-radius:12px;object-fit:cover;">
    <h1>Solasaki Comics</h1>
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="comics.html">Comics</a>
    <a href="writeups.html" class="active">Write-ups</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
    <button class="toggle-mode" onclick="toggleMode()">ðŸŒ™</button>
  </nav>
</header>

<main class="page slide-up" style="max-width:900px;margin:auto;padding:20px;">
  <h2>Write-ups</h2>
<p>This lazy person hasnâ€™t posted anything yetâ€¦ probably thinking about it.</p>
<hr>

  <div id="writeups-list" style="margin-top:30px;">Loading postsâ€¦</div>
</main>

<footer>Â© <span id="year"></span> Solasaki Comics</footer>

<script>
document.getElementById("year").textContent = new Date().getFullYear();

async function fetchGitHubIndex(){
  const apiURL = "https://api.github.com/repos/froggyinwonder/solasakicomics-site/contents/writings";
  console.log("[writeups] trying GitHub API:", apiURL);
  const res = await fetch(apiURL);
  if (!res.ok) {
    const text = await res.text().catch(()=>null);
    throw new Error(`GitHub API returned ${res.status} ${res.statusText} - ${text?text.substring(0,200):''}`);
  }
  return res.json();
}

async function fetchLocalIndexJSON(){
  const url = "writings/index.json";
  console.log("[writeups] trying local fallback:", url);
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Local index.json fetch failed ${res.status}`);
  return res.json();
}

function extractFrontmatter(mdText){
  const front = (mdText.split("---")[1]||"");
  const title = (front.match(/title:\s*["']?(.*?)["']?(\n|$)/) || [])[1] || null;
  const date = (front.match(/date:\s*["']?(.*?)["']?(\n|$)/) || [])[1] || "";
  return {title, date};
}

async function buildListFromGitHub(){
  const listEl = document.getElementById("writeups-list");
  try {
    const files = await fetchGitHubIndex();
    // ensure array
    if (!Array.isArray(files)) throw new Error("GitHub index response not array");
    const mdFiles = files.filter(f=>f.name && f.name.endsWith(".md"));

    if (mdFiles.length === 0) {
      listEl.innerHTML = "<p>No posts yet.</p>";
      return;
    }

    // sort newest -> oldest by filename (recommend yyyy-mm-dd-title.md)
    mdFiles.sort((a,b)=> b.name.localeCompare(a.name));

    let html = "";
    for (const f of mdFiles){
      try {
        const mdRes = await fetch(f.download_url);
        const mdText = await mdRes.text();
        const fm = extractFrontmatter(mdText);
        const slug = f.name.replace(/\.md$/,"");
        const title = fm.title || slug;
        const date = fm.date || "";
        html += `<a class="entry" href="writeup-viewer.html?post=${encodeURIComponent(slug)}" style="display:block;margin-bottom:18px;padding:14px;border-radius:10px;border:1px dashed var(--border);text-decoration:none;color:inherit;">
          <h3 style="margin:0 0 6px 0;">${title}</h3>
          <p style="margin:0;color:var(--muted);font-size:13px;">${date}</p>
        </a>`;
      } catch(e){
        console.warn("[writeups] could not fetch md", f.name, e);
      }
    }
    listEl.innerHTML = html;
  } catch(err) {
    console.error("[writeups] GitHub API failed:", err);
    throw err;
  }
}

async function buildListFromIndexJSON(){
  const listEl = document.getElementById("writeups-list");
  try {
    const idx = await fetchLocalIndexJSON();
    if (!Array.isArray(idx) || idx.length === 0) {
      listEl.innerHTML = "<p>No posts found in index.json</p>";
      return;
    }
    // index.json expects array of { "slug":"welcome-to-solasaki", "title":"...", "date":"..." }
    idx.sort((a,b) => (b.slug || "").localeCompare(a.slug || ""));
    let html="";
    for (const p of idx){
      const slug = p.slug;
      const title = p.title || slug;
      const date = p.date || "";
      html += `<a class="entry" href="writeup-viewer.html?post=${encodeURIComponent(slug)}" style="display:block;margin-bottom:18px;padding:14px;border-radius:10px;border:1px dashed var(--border);text-decoration:none;color:inherit;">
          <h3 style="margin:0 0 6px 0;">${title}</h3>
          <p style="margin:0;color:var(--muted);font-size:13px;">${date}</p>
        </a>`;
    }
    listEl.innerHTML = html;
  } catch(err){
    console.error("[writeups] local index.json failed:", err);
    document.getElementById("writeups-list").innerHTML = "<p>Could not load writeups (check console)</p>";
  }
}

(async function init(){
  const listEl = document.getElementById("writeups-list");
  try {
    await buildListFromGitHub();
    console.log("[writeups] loaded via GitHub API");
  } catch(e) {
    // fallback to local index.json
    console.warn("[writeups] falling back to local index.json");
    await buildListFromIndexJSON();
  }
})();
</script>
<script>
function toggleMode() {
  document.body.classList.toggle("dark-mode");

  // Save mode
  if (document.body.classList.contains("dark-mode")) {
    localStorage.setItem("mode", "dark");
  } else {
    localStorage.setItem("mode", "light");
  }
}

// Load saved preference
if (localStorage.getItem("mode") === "dark") {
  document.body.classList.add("dark-mode");
}
</script>
</body>
</html>
